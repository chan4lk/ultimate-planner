{% extends "base.html" %}

{% block content %}
<div class="task-form">
    <form id="task-form"
          hx-post="/tasks" 
          hx-target="#task-list" 
          hx-swap="innerHTML"
          hx-on::after-request="this.reset()">
        <div class="form-row">
            <div class="input-with-mic">
                <input type="text" 
                       id="task-input"
                       name="text" 
                       placeholder="What needs to be done?" 
                       required
                       autocomplete="off">
                <button type="button" 
                        id="mic-button" 
                        class="mic-button"
                        title="Voice input"
                        aria-label="Start voice input">
                    üé§
                </button>
            </div>
            <select name="label_id" 
                    id="label-select"
                    class="label-select"
                    onchange="if(this.value === '__new__') { document.getElementById('label-modal').style.display = 'flex'; this.value = ''; }">
                <option value="">No Label</option>
                <option value="personal">üå± Personal</option>
                <option value="work">üíº Work</option>
                <option value="urgent">üî• Urgent</option>
                <option value="ideas">üí° Ideas</option>
                <option value="__new__" style="font-weight: 600; color: #6366f1;">‚ûï Add New Label</option>
            </select>
            <button type="submit">Add Task</button>
        </div>
    </form>
</div>

<div class="task-list" id="task-list" hx-get="/tasks" hx-trigger="load">
    <!-- Tasks will be loaded here -->
</div>

<!-- Label Creation Modal -->
<div id="label-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create New Label</h3>
            <button class="modal-close" onclick="document.getElementById('label-modal').style.display = 'none'">‚úï</button>
        </div>
        <form hx-post="/labels"
              hx-target="#label-select"
              hx-swap="innerHTML"
              hx-on::after-request="document.getElementById('label-modal').style.display = 'none'; this.reset();">
            <div class="modal-body">
                <div class="form-group">
                    <label for="label-name">Label Name</label>
                    <input type="text" 
                           id="label-name"
                           name="name" 
                           placeholder="e.g., Shopping, Health, etc." 
                           required
                           autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="label-color">Color</label>
                    <div class="color-picker">
                        <input type="color" 
                               id="label-color"
                               name="color" 
                               value="#6366f1">
                        <span class="color-preview" id="color-preview">#6366f1</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" 
                        class="btn-secondary" 
                        onclick="document.getElementById('label-modal').style.display = 'none'">
                    Cancel
                </button>
                <button type="submit" class="btn-primary">Create Label</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Update color preview when color changes
    document.getElementById('label-color')?.addEventListener('input', function(e) {
        document.getElementById('color-preview').textContent = e.target.value;
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modal = document.getElementById('label-modal');
            if (modal.style.display === 'flex') {
                modal.style.display = 'none';
            }
        }
    });

    // Close modal when clicking outside
    document.getElementById('label-modal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            this.style.display = 'none';
        }
    });

    // Speech Recognition Setup
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    
    if (SpeechRecognition) {
        const recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';

        const micButton = document.getElementById('mic-button');
        const taskInput = document.getElementById('task-input');
        let isRecording = false;

        micButton.addEventListener('click', function() {
            if (isRecording) {
                recognition.stop();
                isRecording = false;
                micButton.classList.remove('recording');
                micButton.textContent = 'üé§';
                micButton.title = 'Voice input';
                taskInput.placeholder = 'What needs to be done?';
            } else {
                try {
                    recognition.start();
                    isRecording = true;
                    micButton.classList.add('recording');
                    micButton.textContent = '‚èπÔ∏è';
                    micButton.title = 'Stop recording';
                    taskInput.placeholder = 'üé§ Listening... Speak now!';
                } catch (error) {
                    console.error('Failed to start recognition:', error);
                    showNotification('‚ö†Ô∏è Failed to start voice input. Please try again.', 'error');
                }
            }
        });

        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            const confidence = event.results[0][0].confidence;
            taskInput.value = transcript;
            taskInput.focus();
            
            // Show success notification with confidence level
            const confidencePercent = Math.round(confidence * 100);
            console.log(`Speech recognized: "${transcript}" (${confidencePercent}% confidence)`);
            
            if (confidencePercent < 70) {
                showNotification(`‚úÖ Heard: "${transcript}"\n‚ö†Ô∏è Low confidence (${confidencePercent}%). Please verify.`, 'info');
            }
        };

        recognition.onerror = function(event) {
            console.error('Speech recognition error:', event.error);
            isRecording = false;
            micButton.classList.remove('recording');
            micButton.textContent = 'üé§';
            micButton.title = 'Voice input';
            
            // Detailed error messages
            let errorMessage = '';
            switch(event.error) {
                case 'not-allowed':
                case 'permission-denied':
                    errorMessage = 'üé§ Microphone access denied.\n\nPlease:\n1. Click the üîí icon in your browser address bar\n2. Allow microphone access\n3. Refresh the page';
                    break;
                case 'no-speech':
                    errorMessage = 'üîá No speech detected. Please try again and speak clearly.';
                    break;
                case 'audio-capture':
                    errorMessage = 'üé§ No microphone found. Please connect a microphone and try again.';
                    break;
                case 'network':
                    errorMessage = 'üåê Network error. Please check your internet connection.';
                    break;
                case 'aborted':
                    // User stopped - no alert needed
                    console.log('Speech recognition aborted by user');
                    return;
                case 'service-not-allowed':
                    errorMessage = '‚ö†Ô∏è Speech recognition service not available. Please use HTTPS or localhost.';
                    break;
                default:
                    errorMessage = `‚ö†Ô∏è Speech recognition error: ${event.error}\n\nPlease try again or type manually.`;
            }
            
            if (errorMessage) {
                // Show error in a more user-friendly way
                showNotification(errorMessage, 'error');
            }
        };

        // Simple notification function
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        recognition.onend = function() {
            isRecording = false;
            micButton.classList.remove('recording');
            micButton.textContent = 'üé§';
            micButton.title = 'Voice input';
            taskInput.placeholder = 'What needs to be done?';
        };
    } else {
        // Hide mic button if speech recognition is not supported
        const micButton = document.getElementById('mic-button');
        if (micButton) {
            micButton.style.display = 'none';
        }
        console.warn('Speech recognition not supported in this browser');
    }
</script>
{% endblock %}
